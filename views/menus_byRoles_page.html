<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>MPERP2015</title>
    <!-- lib css -->
    <link href="lib/bootstrap-3.3.4/css/bootstrap.min.css" rel="stylesheet" />
    <link href="lib/metisMenu/metisMenu.min.css" rel="stylesheet" />
    <link href="lib/SDAdmin2/dist/css/sb-admin-2.css" rel="stylesheet" />
    <link href="lib/font-awesome-4.3.0/css/font-awesome.min.css" rel="stylesheet" />

    <!-- Kendo UI -->
    <link href="lib/Kendo/styles/kendo.common.min.css" rel="stylesheet" />
    <link href="lib/Kendo/styles/kendo.silver.min.css" rel="stylesheet" />
    <link href="lib/Kendo/styles/kendo.dataviz.min.css" rel="stylesheet" />
    <link href="lib/Kendo/styles/kendo.dataviz.silver.min.css" rel="stylesheet" />


</head>
<body>

    <!-- lib -->
    <script src="lib/jQuery/jquery-2.1.4.min.js"></script>
    <script src="lib/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script src="lib/metisMenu/metisMenu.min.js"></script>
    <script src="lib/SDAdmin2/dist/js/sb-admin-2.js"></script>
    <script src="lib/js.cookie/js.cookie.js"></script>

    <!--Kendo UI-->
    <script src="lib/Kendo/js/kendo.all.min.js"></script>

    <!--MP-->
    <script src="scripts/mp_utilities.js"></script>
    <script src="scripts/globals.js"></script>

    <h1 class="page-header">角色功能選單</h1>

    <input id="lstRoles" />

    <div id="treeview"></div>

    <script>
        
        var roles_apiUrl = "/Membership/roles";
        var roleMenu_apiUrl = "/Membership/RoleMenu";
        var menusJSON_apiUrl = "/api/Menus/Json/Role";

        $("#lstRoles").kendoDropDownList({
            dataTextField: "name",
            dataValueField: "id",
            dataSource: {
                transport: {
                    read: {
                        dataType: "json",
                        url: roles_apiUrl,
                    }
                }
            },
            dataBound: function (e) {
                this.select(0);
                this.trigger("select", { item: $("li.k-state-selected", $("#lstRoles-list")) });
            },
            select: function (e) {
                var dataItem = this.dataItem(e.item);
                //console.log("event :: select (" + dataItem.name + " : " + dataItem.id + ")");
                refreshTreeView(dataItem.id);
            }
        });

        $("#treeview").kendoTreeView({
            dataSource: {
                transport: {
                    read: {
                        url: menusJSON_apiUrl + "/0" ,
                        dataType: "json"
                    }
                },
                schema: {
                    model: {
                        id: "id",
                        hasChildren: "hasChildren",
                        children: "subMenus"
                    }
                }
            },
            dataTextField: "text",
            dragAndDrop: true,
            checkboxes: {
                checkChildren: true
            },
            dataBound: function () {
                this.expand(".k-item");
            },
            check: function (e) {
                var dataItem = getDataItem(e.node);
                console.log(dataItem.id + " : " + dataItem.checked);
                var role = $("#lstRoles").data("kendoDropDownList").dataItem();

                var roleMenu = {
                    "roleId": role.id,
                    "menuId": dataItem.id
                };

                var api_type = dataItem.checked ? "POST" : "DELETE";

                $.ajax({
                    type: api_type,
                    url: roleMenu_apiUrl,
                    data: JSON.stringify(roleMenu),
                    contentType: "application/json; charset=utf-8",
                    success: function (data, status, jqXHR) {
                        refreshTreeView(role.id);
                    },
                    error: function (xhr) {
                        alert(xhr.responseText);
                    }
                });
                
            }
        });
        
        function getDataItem(treeNode) {
            var treeview = $("#treeview").data("kendoTreeView");
            var uid = $(treeNode).data("uid");
            return treeview.dataSource.getByUid(uid);
        }

        function refreshTreeView(roleId) {
            var treeview = $("#treeview").data("kendoTreeView");
            treeview.dataSource.transport.options.read.url = menusJSON_apiUrl + "/" + roleId;
            treeview.dataSource.read();
        }
    </script>


</body>
</html>
