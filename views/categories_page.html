<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>MPERP2015</title>
    <!-- lib css -->
    <link href="lib/bootstrap-3.3.4/css/bootstrap.min.css" rel="stylesheet" />
    <link href="lib/metisMenu/metisMenu.min.css" rel="stylesheet" />
    <link href="lib/SDAdmin2/dist/css/sb-admin-2.css" rel="stylesheet" />
    <link href="lib/font-awesome-4.3.0/css/font-awesome.min.css" rel="stylesheet" />

    <!-- Kendo UI -->
    <link href="lib/Kendo/styles/kendo.common.min.css" rel="stylesheet" />
    <link href="lib/Kendo/styles/kendo.silver.min.css" rel="stylesheet" />
    <link href="lib/Kendo/styles/kendo.dataviz.min.css" rel="stylesheet" />
    <link href="lib/Kendo/styles/kendo.dataviz.silver.min.css" rel="stylesheet" />


</head>
<body>

    <!-- lib -->
    <script src="lib/jQuery/jquery-2.1.4.min.js"></script>
    <script src="lib/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script src="lib/metisMenu/metisMenu.min.js"></script>
    <script src="lib/SDAdmin2/dist/js/sb-admin-2.js"></script>
    <script src="lib/js.cookie/js.cookie.js"></script>

    <!--Kendo UI-->
    <script src="lib/Kendo/js/kendo.all.min.js"></script>

    <!--MP-->
    <script src="scripts/mp_utilities.js"></script>
    <script src="scripts/globals.js"></script>

    <h1 class="page-header">產品分類</h1>
    <div id="gridCategories"></div>

    <script>

        var categoriesView_apiUrl = "/api/categories";
        var categoriesView_dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: categoriesView_apiUrl,
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + Cookies.get('token'));
                    }
                },
                update: {
                    url: function (data) {
                        return categoriesView_apiUrl + "/" + data.id;
                    },
                    type: "put",
                    contentType: "application/json",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + Cookies.get('token'));
                    }
                },
                destroy: {
                    url: function (data) {
                        return categoriesView_apiUrl + "/" + data.id;
                    },
                    type: "delete",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + Cookies.get('token'));
                    }
                },
                create: {
                    url: categoriesView_apiUrl,
                    type: "post",
                    contentType: "application/json",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + Cookies.get('token'));
                    }
                },
                parameterMap: function (data, operation) {
                    if (operation == "create") {
                        data.id = 0;
                    }
                    return JSON.stringify(data);
                }
            },
            error: function (err) {
                if (err.xhr.status=="401") {
                    window.location.href = "../Login.html";
                } else if (err.xhr.status == "409") {
                    var message = (err.xhr.responseText == "") ? "" : JSON.parse(err.xhr.responseText).message + "\n";

                    alert(err.xhr.status + "\n" + message + "將重新載入資料!");                    

                    $('#gridCategories').data('kendoGrid').dataSource.read();
                    $('#gridCategories').data('kendoGrid').refresh();
                } else {
                    throw err;
                }
            },
            schema: {
                model: {
                    id: "id",
                    fields: {
                        id: { editable: false, nullable: false },
                        name: { validation: { required: true } },
                        timestampString: { editable: false }
                    }
                }
            }
        });

        $("#gridCategories").kendoGrid({
            dataSource: categoriesView_dataSource,
            height: 550,
            toolbar: ["create"],
            columns: [
                { field: "id", title: "分類編號", width: "120px" },
                { field: "name", title: "分類名稱", width: "120px" },
                { command: ["edit", "destroy"], title: "&nbsp;", width: "250px" }
            ],
            editable: "inline"
        });

    </script>


</body>
</html>
