<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MPERP2015</title>
    <!-- Bootstrap Core CSS -->
    <link href="../SDAdmin2/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- MetisMenu CSS -->
    <link href="../SDAdmin2/bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../SDAdmin2/dist/css/sb-admin-2.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="../SDAdmin2/bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- Kendo UI -->
    <link rel="stylesheet" href="http://cdn.kendostatic.com/2015.1.429/styles/kendo.common.min.css" />
    <link rel="stylesheet" href="http://cdn.kendostatic.com/2015.1.429/styles/kendo.default.min.css" />
    <link rel="stylesheet" href="http://cdn.kendostatic.com/2015.1.429/styles/kendo.silver.min.css" />
    <link rel="stylesheet" href="http://cdn.kendostatic.com/2015.1.429/styles/kendo.dataviz.min.css" />
    <link rel="stylesheet" href="http://cdn.kendostatic.com/2015.1.429/styles/kendo.dataviz.default.min.css" />
    <link rel="stylesheet" href="http://cdn.kendostatic.com/2015.1.429/styles/kendo.dataviz.silver.min.css" />

</head>
<body>

    <!-- jQuery -->
    <script src="../SDAdmin2/bower_components/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="../SDAdmin2/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- Metis Menu Plugin JavaScript -->
    <script src="../SDAdmin2/bower_components/metisMenu/dist/metisMenu.min.js"></script>
    <!-- Custom Theme JavaScript -->
    <script src="../SDAdmin2/dist/js/sb-admin-2.js"></script>

    <!--Kendo UI-->
    <script src="http://cdn.kendostatic.com/2015.1.429/js/kendo.all.min.js"></script>

    <!--mp_utilities-->
    <script src="scripts/mp_utilities.js"></script>

    <script src="scripts/js.cookie.js"></script>

    <script id="errorTemplate" type="text/x-kendo-template">
        <div class="wrong-pass">
            <img src="images/error-icon.png" />
            <h3>#= title #</h3>
            <p>#= message #</p>
        </div>
    </script>

    <script id="successTemplate" type="text/x-kendo-template">
        <div class="upload-success">
            <img src="images/success-icon.png" />
            <h3>#= message #</h3>
        </div>
    </script>

    <h1 class="page-header">產品分類</h1>
    <div id="gridCategories"></div>
    <span id="notification" style="display:none;"></span>

    <script>
        var notification = $("#notification").kendoNotification({
            position: {
                //pinned: true,
                top: 30,
                //right: 500,
                //width: 500,
                height: 50
            },
            autoHideAfter: 0,
            //stacking: "up",
            templates: [{
                type: "error",
                template: $("#errorTemplate").html()
            }, {
                type: "success",
                template: $("#successTemplate").html()
            }]
        }).data("kendoNotification");


        var categoriesView_apiUrl = "/api/categories";
        var categoriesView_dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: categoriesView_apiUrl,
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + Cookies.get('token'));
                    }
                },
                update: {
                    url: function (data) {
                        return categoriesView_apiUrl + "/" + data.id;
                    },
                    type: "put",
                    contentType: "application/json",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + Cookies.get('token'));
                    }
                },
                destroy: {
                    url: function (data) {
                        return categoriesView_apiUrl + "/" + data.id;
                    },
                    type: "delete",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + Cookies.get('token'));
                    }
                },
                create: {
                    url: categoriesView_apiUrl,
                    type: "post",
                    contentType: "application/json",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + Cookies.get('token'));
                    }
                },
                parameterMap: function (data, operation) {
                    if (operation == "create") {
                        data.id = 0;
                    }
                    return JSON.stringify(data);
                }
            },
            error: function (err) {
                if (err.xhr.status=="401") {
                    window.location.href = "../Login.html";
                } else if (err.xhr.status == "409") {
                    var message = (err.xhr.responseText == "") ? "" : JSON.parse(err.xhr.responseText).message + "\n";

                    //alert(err.xhr.status + "\n" + message + "將重新載入資料!");                    
                    notification.show({
                        title: "資料衝突",
                        message: message
                    }, "error");

                    $('#gridCategories').data('kendoGrid').dataSource.read();
                    $('#gridCategories').data('kendoGrid').refresh();
                } else {
                    throw err;
                }
            },
            schema: {
                model: {
                    id: "id",
                    fields: {
                        id: { editable: false, nullable: false },
                        name: { validation: { required: true } },
                        timestampString: { editable: false }
                    }
                }
            }
        });

        $("#gridCategories").kendoGrid({
            dataSource: categoriesView_dataSource,
            height: 550,
            toolbar: ["create"],
            columns: [
                { field: "id", title: "分類編號", width: "120px" },
                { field: "name", title: "分類名稱", width: "120px" },
                { command: ["edit", "destroy"], title: "&nbsp;", width: "250px" }
            ],
            editable: "inline"
        });

    </script>


</body>
</html>
